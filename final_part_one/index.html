<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Platformer Game</title>
    <script src="jquery.js"></script>
</head>
<body onclick="shoot()">
    <audio id="laser" src="audio/laser.mp3"></audio>
    <canvas id="mycanvas" width="2000" height="800" style="position:absolute;left:0px;top:126px;z-index:710;background-color:transparent"></canvas>
     <div id="plats_image" style="position: absolute; top: 30px; left: 0px; width: 1100px; height: 790px; background-image: url('images/platforms.png'); background-size: 100% 100%; z-index: 1000"></div>
    <div style="position:absolute;top:0px;left:1100px;width:1000px;height:1000px;background:white;z-index:1000"></div>
    <div id="content_main">
        <div id="background" style="position:absolute;left:0px;top:0px;px; width:9000px;height:700px;z-index:1">
            <img style="position:relative;top:40px;left:-50px;opacity:1.0;visibility:visible;z-index:1" src="images/Medieval countryside.png" alt="Photo" id="level1_image" width="2200" height="790" />
            <div id="the_bullets" style="z-index:740"></div>
            <div id="healthbar" style="z-index:740;width:10px;background-color:red;height:800px;position:absolute;left:1080px;top:40px"></div>
            <div id="green_knight_healthbar" style="z-index:740;width:10px;background-color:green;height:800px;position:absolute;left:20px;top:40px"></div>
            <div id="tobi" style="position:absolute;top:629px;left:50px;z-index:700">
                <img id="tobi_image" src="images/Bones.png" height="100" width="72" style="position:relative;top:28px" />
            </div>
            <div id="green_knight" style="position:absolute;top:300px;left:300px;z-index:700">
                <img id="green_knight_image" src="images/KnightGeneral.gif" height="200" width="140" style="position:relative;top:8px;visibility:hidden" />
            </div>
            <div id="green_knight" style="position:absolute;top:300px;left:300px;z-index:700">
                <img id="green_knight_damage" src="images/KnightGeneral_damaged.png" height="200" width="140" style="position:relative;top:8px;visibility:hidden" />
            </div>
            <div id="enemy0" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image0" src="images/GoldenKnight.gif" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy1" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image1" src="images/SpearKnight.gif" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy2" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image2" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy3" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image3" src="images/RedKnight.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy4" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image4" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy5" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image5" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy6" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image6" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy7" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image7" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy8" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image8" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="enemy9" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image9" src="images/KnightGrunt.png" width="90" style="position:relative;top:12px" />
            </div>
            <div id="animatedtext" style="position:absolute;left:760px;top:100px;width:400px;height:110px;z-index:520;color:#000000;font-size:48px;font-family:'Trebuchet MS', Arial, Helvetica, sans-serif;background:transparent">
                SCORE: <span id="thescore">0</span><br />
            </div>
            <div id="enemy10" style="position:absolute;top:629px;left:500px;z-index:700">
                <img id="enemy_image10" src="images/Knight_melee.png" width="90" style="position:relative;top:12px" />
            </div>

                <div id="game over" style="position:absolute;left:0px;top:0px;px; width:20000px;height:800px;z-index:1">
                    <img style="position:relative;top:40px;left:-50px;opacity:1.0;visibility:hidden";z-index:1" src="images/Game_Over.jpg" alt="Photo" id="game over" width="2200" height="790" />
                    <script language="javascript">
var plats = [
                [0,678,1000,718], //x_start, y_start, x_end, y_end
                [380,568,570,588],
                [100,500,290,520],
                [410,410,540,430],
                [60,310,250,330],
                [460,270,575,290],
                [100,70,400,100],
                [840,510,1000,532],
                [720,340,870,364],
            ];

            var enemies = [
                [0,678,1], //x, y, and [0:dead, 1:alive]
                [226,556,1],
                [589,0,1],
                [866,656,1],
                [380,120,1],
                [0,678,1],
                [226,556,1],
                [589,0,1],
                [866,656,1],
                [380,120,1],
                [400,656,5]
            ];

            var bullets = [
                [0,-1000,1], //x, y, and [0:not-active, 1:active]
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1],
                [0,-1000,1]
            ];

            var e_bullets = [
                [0,-1000,-1], //x, y, and [-1:not-active, 1:active]
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1],
                [0,-1000,-1]
            ];
            var enemy_count = 10;
            var current_bullet = 0;
            var current_e_bullet = 0;
            var star_angle = 0;
            var canvas=document.getElementById('mycanvas');
            var context=canvas.getContext('2d');
            for(i=0;i<plats.length;i++) {
                context.beginPath();
                context.fillStyle = "rgba(255, 255, 255, 0.4)";
                context.fillRect(plats[i][0], plats[i][1], plats[i][2]-plats[i][0], plats[i][3]-plats[i][1]);  // where the rectangle platforms are (me)
            }

            KeysDown = new Array(0,0,0,0,0,0); //asdwbj

            window.onload = function() {
              init();
            }

            $(document.body).keydown(function (evt) {
                actualkey=String.fromCharCode(evt.keyCode);
                if(actualkey=="A") {
                    KeysDown[0] = 1;
                }
                if(actualkey=="S") {
                    KeysDown[1] = 1;
                }
                if(actualkey=="D") {
                    KeysDown[2] = 1;
                }
                if(actualkey=="W") {
                    KeysDown[3] = 1;
                }
                if(actualkey=="B") {
                    KeysDown[4] = 1;
                }
                if(actualkey=="J") {
                    KeysDown[5] = 1;
                }
            });
            var snd = new Audio("audio/whoosh.wav");
            var bg_sound = new Audio("audio/8-bit music.wav");
            var ai = new Array(0,0,1,1);
            var ai_index = 0;
            bg_sound.play();
            bg_sound.loop = true;
            bg_sound.volume = 0.15;
            var msc = new Audio ("audio/8 Bit Battle Song.wav");
            $(document.body).keyup(function (evt) {
                actualkey=String.fromCharCode(evt.keyCode);
                if(actualkey=="A") {
                    KeysDown[0] = 0;
                }
                if(actualkey=="S") {
                    KeysDown[1] = 0;
                }
                if(actualkey=="D") {
                    KeysDown[2] = 0;
                }
                if(actualkey=="W") {
                    KeysDown[3] = 0;
                }
                if(actualkey=="B") {
                    KeysDown[4] = 0;
                }
                if(actualkey=="J") {
                    KeysDown[5] = 0;
                }
            });

            function init() {
              sprite = document.getElementById("tobi");
              x = 0;
              y = -100;
              bx = -50;
              by = 0;
              score = 0;
              health = 0;
              green_knight_health = 800;
              tobi_x = 50; tobi_y = 629;
              green_knight_x = 300; green_knight_y = 300;
              speed = 1.25;
              shot_taken = -1;
              death_sequence = -1;
              bullet_direction=1;
              jumptime = 1;
              jump_speed = 3;
              falling = 2;
              for (i=0;i<enemies.length;i++) {
                  //pick a random platform
                  p = Math.floor(Math.random() * (plats.length-2) + 1);
                  //put the enemy there
                  if(p==1) {
                      enemies[i][0] = plats[p][0];
                  } else {
                      enemies[i][0] = plats[p][0]+(10*i);
                  }
                  enemies[i][1] = plats[p][1]+32;
                  document.getElementById('enemy' + i).style.left = enemies[i][0] + "px";
                  document.getElementById('enemy' + i).style.top = enemies[i][1] + "px";
              }
              for(i=0;i<bullets.length;i++) {
                document.getElementById('the_bullets').innerHTML += '<div id="bullet' + i + '" style="position:absolute;top:0px;left:0px;z-index:600"><img style="opacity:1.0; visibility:visible;" src="images/minecraftSwordBullet.png" alt="bullet" id="dot_image"></div>';
                bullets[i][1] = -1000.0;
              }
              for(i=0;i<e_bullets.length;i++) {
                document.getElementById('the_bullets').innerHTML += '<div id="e_bullet' + i + '" style="position:absolute;top:0px;left:0px;z-index:600"><img style="opacity:1.0; visibility:visible;" src="images/minecraftSwordBullet.png" alt="bullet"></div>';
                e_bullets[i][1] = -1000.0;
              }

              var canvas=document.getElementById('mycanvas');
              var context=canvas.getContext('2d');
              var radius = 8;
              frameloop(1.0, 0);
            }

            function shoot() {
            snd.play ();
                if(shot_taken < 0) {
                    bullets[current_bullet][0] = tobi_x;
                    bullets[current_bullet][1] = tobi_y+64;
                    bullets[current_bullet][2] = bullet_direction;
                    current_bullet++;
                    if(current_bullet >= bullets.length) {
                        current_bullet=0;
                    }
                    shot_taken = 20;
                    document.getElementById("laser").play();
                }
            }

            function process_keys() {
                c = document.getElementById('clyde');
                tobi = document.getElementById('tobi');
                if (KeysDown[0] == 1 && death_sequence < 0) { // a key is down
                    bullet_direction=-1;
                    document.getElementById('tobi_image').src="images/Bones_l.png";
                    if(checkValidMove(tobi_x - speed, tobi_y)) {
                        tobi_x = tobi_x - speed;
                    }
                    if(tobi_x < 0) {
                        tobi_x = 2;
                    } else {
                        tobi.style.left = tobi_x + "px";
                        bx += speed;
                        if(bx > 0) {
                            bx = 0;
                        }
                    }
                    document.getElementById('level1_image').style.left = bx + "px";
                }
                if (KeysDown[2] == 1 && death_sequence < 0) { //d key is down
                    bullet_direction=1;
                    document.getElementById('tobi_image').src="images/Bones.png";
                    if(checkValidMove(tobi_x + speed, tobi_y)) {
                        tobi_x = tobi_x + speed;
                    }
                    if(tobi_x > 950) {
                        tobi_x = 950;
                    } else {
                        tobi.style.left = tobi_x + "px";
                        bx -= speed;
                        if(bx > 1000) {
                            bx = 1000;
                        }
                    }
                    document.getElementById('level1_image').style.left = bx + "px";
                }
                if (KeysDown[3] == 1 && death_sequence < 0) { // w key is down
                    if (jumptime <= 0) {
                        document.getElementById('tobi_image').src="images/Bones.png";
                        jumptime=180;
                    }
                }
                for(c=0; c<enemies.length; c++) {
                    if(hit_test(tobi_x+20, enemies[c][0]+20, tobi_y+32, enemies[c][1], 40) && enemies[c][2]==1) {
                        enemies[c][2]=0;
                        score -= 40;
                        document.getElementById('thescore').innerHTML = score;
                        document.getElementById('enemy_image' + c).style.visibility = "hidden";
                        enemy_count = enemy_count - 1;
                    }
                }
            }

            /* The frameloop function uses a Timeout to call itself every 150ms */
            function frameloop(opacity,fcount) {
                process_keys();
                star_angle = star_angle + Math.random()*1 + 6;
                if(enemy_count == 0) {
            msc.play ();
            bg_sound.pause ();
                    document.getElementById('green_knight_image').style.visibility = 'visible';
                    enemy_count--;
                } else if(enemy_count < 0) {
                    green_knight_x = green_knight_x + (tobi_x - green_knight_x)*0.0002;
                    document.getElementById('green_knight').style.left = green_knight_x + "px";
                    green_knight_y = green_knight_y + ((tobi_y+40) - green_knight_y)*0.0004;
                    document.getElementById('green_knight').style.top = green_knight_y + "px";
                    green_knight_health = green_knight_health;
                    document.getElementById('green_knight_healthbar').style.height = "" + green_knight_health + "px";
                    if(death_sequence == 0) {
                        document.getElementById('green_knight_image').src="images/KnightGeneral.gif";

                    }

                }

                if(jumptime > 0) {
                    if(jumptime > 90) {
                        if(checkValidMove(tobi_x, tobi_y - jump_speed)) {
                            tobi_y = tobi_y - jump_speed;
                        }
                    } else {
                        if(checkValidMove(tobi_x, tobi_y + jump_speed)) {
                            tobi_y = tobi_y + jump_speed;
                        } else {
                            jumptime = 0;
                        }
                    }
                    jumptime--;
                    falling=-1;
                } else {
                    falling=1;
                }

                if(falling==1) {
                    if(checkValidMove(tobi_x, tobi_y + 1)) {
                        tobi_y = tobi_y + 1;
                    }
                }
            //UPDATE DEMONS ATTACK
                for(j=0;j<enemies.length;j++) {
                    if(enemies[10][2] > 1) {
                    	//alert('knight melee is moving');
                   		//if(checkValidMove(bullets[j][0], Math.floor(enemies[j][1] + ((tobi_y+110) - enemies[j][1])*0.005))) {
                        enemies[10][1] = enemies[10][1] + ((tobi_y+100) - enemies[10][1])*0.0005;
                        //alert(enemies[10][1]);
                        document.getElementById('enemy' + 10).style.top = enemies[10][1] + "px";
                     	//}
                      	//if(checkValidMove(Math.floor(enemies[j][0] + ((tobi_x+100) - enemies[j][0])*0.005), bullets[j][1]-110)) {
                    	enemies[10][0] = enemies[10][0] + ((tobi_x) - enemies[10][0])*0.0005;
                        document.getElementById('enemy' + 10).style.left = enemies[10][0] + "px";
                     	//}
                    }
                    if(Math.random() < 0.002 && enemies[j][2] > 0) {
                        e_bullets[current_e_bullet][0] = enemies[j][0];
                        e_bullets[current_e_bullet][1] = enemies[j][1]+34;
                        dir = Math.floor(Math.random()*2);
                        if(e_bullets[current_e_bullet][2]==-1) {
                            if(dir==0 && enemies[j][0] > tobi_x) {
                                dir=2;
                            } else if(dir==1 && enemies[j][1] < tobi_y) {
                                dir=3;
                            }
                            e_bullets[current_e_bullet][2] = dir;
                            current_e_bullet++;
                            if(current_e_bullet >= e_bullets.length) {
                                current_e_bullet = 0;
                            }
                        }
                    }
                }
                //UPDATE BULLETS FIRED BY OPPONENTS
                for(j=0;j<e_bullets.length;j++) {
                    if(enemy_count < 0) {
                        if(e_bullets[j][2] == -1) {
           // if (Math.random () < 0.002) {
                            e_bullets[j][0] = green_knight_x;
                            e_bullets[j][1] = green_knight_y + 40;
                            e_bullets[j][2] = Math.floor(Math.random() * 4);
          // }
                        }
                    }
                    if(enemy_count < 0) {
                 //   if (green_knight_health > -400) {
                     //   e_bullet_speed = 3;

                 //   } else {
                        e_bullets[j][0] += (1.5 * (tobi_x - green_knight_x) / 200); //X movement
                        e_bullets[j][1] += (1.5 * (tobi_y - green_knight_y) / 200); //Y movement
                    } else {
                        if(e_bullets[j][2] == 0) {
                            e_bullets[j][0] += 3;
                        } else if(e_bullets[j][2] == 2) {
                            e_bullets[j][0] -= 3;
                        } else if(e_bullets[j][2] == 1) {
                            e_bullets[j][1] -= 3;
                        } else if(e_bullets[j][2] == 3) {
                            e_bullets[j][1] += 3;
                        }
                    }
                    if(hit_test(e_bullets[j][0],tobi_x+20,e_bullets[j][1],tobi_y+72, 40)) {
                        e_bullets[j][2] = -1;
                        e_bullets[j][0] = -1000;
                        e_bullets[j][1] = -1000;
                        score = score - 80;
                        document.getElementById('thescore').innerHTML = score;
                        document.getElementById('tobi_image').src="images/Bones_death.png";
                        health = health - 80;
                        document.getElementById('healthbar').style.height = "" + (800 + health) + "px";
                        death_sequence=100;
                    }
                     if (health <= -800) {
                        document.getElementById('plats_image').style.backgroundImage = "url('images/lose.png')";
                            game_active = -1;
                  //  alert ("game over...");

                     }
                    if(e_bullets[j][0] > 1000 || e_bullets[j][0] < 0 || e_bullets[j][1] > 820 || e_bullets[j][1] < 0) {
                        e_bullets[j][2] = -1;
                        e_bullets[j][0] = -1000;
                        e_bullets[j][1] = -1000;
                    }
                    document.getElementById('e_bullet' + j).style.left = e_bullets[j][0] + "px";
                    document.getElementById('e_bullet' + j).style.top = e_bullets[j][1] + "px";
                    document.getElementById('e_bullet' + j).style.transform = "rotate(" + star_angle + "deg)";
                }
                //UPDATE BULLETS SHOT BY tobi
                for(j=0;j<bullets.length;j++) {
                    if(checkValidMove(bullets[j][0] + 5*bullets[j][2], bullets[j][1]-110)) {
                        bullets[j][0] += 5*bullets[j][2];
                    } else {
                        bullets[j][1] = -1000;
                    }
                    if(bullets[j][0] > 1000) {
                        bullets[j][0] = 0;
                        bullets[j][1] = -1000;
                    } else if(bullets[j][0] < 0) {
                        bullets[j][0] = 1000;
                        bullets[j][1] = -1000;
                    }
                    for(k=0;k<enemies.length;k++) {
                        if(hit_test(bullets[j][0],enemies[k][0],bullets[j][1],enemies[k][1]+50, 40)) {
                            enemies[k][0]=-1000;
                            enemies[k][1]=-1000;
                            enemies[k][2]=0;
                            if(enemies[k][2]==2) {
                                //find a new attack enemy
                                found=false;
                                for(idx=0;idx<enemies.length;idx++) {
                                    if(!found) {
                                        if(enemies[idx][2]==1) {
                                            enemies[idx][2]=2;
                                            found=true;
                                        }
                                    }
                                }
                            }
                            document.getElementById('enemy' + k).style.visibility = "hidden";
                            bullets[j][1]=-1000;
                            score += 100;
                            document.getElementById('thescore').innerHTML = score;
                            enemy_count--;
                        }
                        if(enemy_count < 0) {
                            if(hit_test(bullets[j][0],green_knight_x - 30,bullets[j][1],green_knight_y+124,100)) {
                                document.getElementById('green_knight_image').src="images/KnightGeneral_damaged.png";
                                death_sequence=100;
                                bullets[j][1]=-1000;
                                score += 100;
                                document.getElementById('thescore').innerHTML = score;
                                green_knight_health -= 1000;
                              document.getElementById('green_knight_healthbar').style.height = "" + ( 800 + green_knight_health) + "px";
                    if (green_knight_health = -400) {
                        e_bullet_speed = 50;
                    }
                                if (green_knight_health <= -800) {
                    document.getElementById('plats_image').style.backgroundImage = "url('images/win.png')";
                                    game_active = -1;
                          //          alert ("You won!!!");
          //  document.getElementById('game over').innerHTML ="visible";

                                }

                            }
                        }
                    }
                    document.getElementById('bullet' + j).style.left = bullets[j][0] + "px";
                    document.getElementById('bullet' + j).style.top = bullets[j][1] + "px";
                }
                shot_taken--;
                death_sequence--;
                tobi.style.top = tobi_y + "px";

                window.setTimeout("frameloop("+opacity+","+fcount+")", 5);
            }

            function checkValidMove(x, y) {
                for(i=0; i<plats.length; i++) {
                    if(plats[i][0]-32 < x && plats[i][2] > x && plats[i][1] < y && plats[i][3]+20 > y) {
                        return false;
                    }
                }
                return true;
            }

            function checkValidLocation(x, y) {
                if(y > 620) {
                    return false;
                }
                for(i=0; i<plats.length; i++) {
                    if(plats[i][0] < x && plats[i][2] > x && plats[i][1] - 10 < y && plats[i][3] + 10 > y) {
                        return false;
                    }
                }
                for(i=0; i<enemies.length; i++) {
                    if(enemies[i][0] < x && enemies[i][0] + 50 > x && enemies[i][1] < y && enemies[i][1] + 50 > y) {
                        return false;
                    }
                }
                return true;
            }

            function hit_test(x0,x1,y0,y1,t) {
                //alert(Math.sqrt((x0-x1)*(x0-x1) + (y0-y1)*(y0-y1)));
                if(Math.sqrt((x0-x1)*(x0-x1) + (y0-y1)*(y0-y1)) < t) {
                    return true;
                } else {
                    return false;
                }
            }
            </script>
                </div>
            </div>
            <script src="prologue1.js"></script>
            <script src="prologue2.js"></script>
            <script src="level1.js"></script>
            <script src="level2.js"></script>
            <script src="level3.js"></script>
</body>
</html>


//For next session, ask Dr. Campbell how to make a start and game over menu and how to kill the boss.

// need a damage image for boss in line 458
// Change how the green knight moves in lines 312 and 314
// Figure out why the bullet registers a hit before it reaches the knight
// figure out a final death sequence (How the green knight would die)
// it would take 8 hits to kill the green knight boss
// Line 457 - play around with collision detection equation (the hit_test parameters)

// make a new div for start, win, and game over menu  (visibility, src, document.getelementbyid)
// stop the frame loop (window.setTimeout("frameloop("+opacity+","+fcount+")", 5);) with a if statement and a variable called, "game over".
// make the boss more aggressive when his health is decreased to 400 
// make the 8 bit knight an intelligent A.I melee enemy
// make power ups (shield and ammo)
// make a function to make the player have limited amount of ammunition (greater than 0 can't be shot)
// make comments of where the code will go if there's not enough time.
// try to change the sword's direction for the right side 
// understand the code
// get rid of the platform images and try to draw them into the background (optional)